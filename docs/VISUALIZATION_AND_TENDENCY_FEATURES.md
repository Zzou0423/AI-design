# 可视化与倾向控制功能文档

## 📅 更新时间
2025-10-30

## 🎯 新增功能概述

本次更新增加了两个重要功能：
1. **分析结果可视化**：为分析报告添加词云图、主题分布图、情感分布图等可视化内容
2. **答案生成倾向控制**：允许指定生成答案的整体倾向，便于验证分析结果的准确性

---

## 📊 功能一：分析结果可视化

### 设计目标

传统的纯文字分析报告缺乏直观性，用户难以快速把握数据的整体趋势。通过添加可视化图表，可以：
- 更直观地展示数据分布
- 快速识别关键主题和趋势
- 增强报告的可读性和专业性

### 实现内容

#### 1. 新增可视化服务 (`app/services/visualization_service.py`)

创建了专门的可视化服务类，支持生成多种图表：

**支持的图表类型**：
- **词云图** (`generate_wordcloud`)：展示高频词汇和主题
- **主题分布柱状图** (`generate_theme_distribution_chart`)：显示各主题的提及频次
- **情感分布饼图** (`generate_sentiment_pie_chart`)：展示积极/消极/中性主题的比例
- **量表题分布图** (`generate_scale_distribution_chart`)：显示评分分布
- **选择题分布图** (`generate_choice_distribution_chart`)：显示选项选择频次

**技术实现**：
- 使用 `wordcloud` 库生成词云
- 使用 `matplotlib` 绘制各类图表
- 图表转换为 Base64 编码的图片，直接嵌入HTML
- 自动处理中文字体（Windows系统使用黑体）

#### 2. 集成到分析引擎

**开放题分析**（`SurveyAnalysisEngine`）：
- 在生成文本报告的同时，自动生成3张可视化图表
- 词云图：展示开放题回答的高频词汇
- 主题分布图：显示各主题的提及次数
- 情感分布饼图：展示情感倾向的比例

**全量分析**（`FullAnalysisService`）：
- 已预留可视化接口
- 可针对不同题型生成相应图表

#### 3. 前端显示优化

更新了分析结果页面（`run_all.py`）：
- 在文字报告之前显示可视化图表区域
- 词云图居中全宽显示
- 主题分布图和情感分布图并排显示（Grid布局）
- 图表与文字报告用分隔线区分

### 使用效果

分析报告现在包含：
```
┌─────────────────────────────────────┐
│      📊 数据可视化                   │
├─────────────────────────────────────┤
│                                     │
│        🔠 主题词云                   │
│     [词云图 - 展示高频词汇]          │
│                                     │
├──────────────┬──────────────────────┤
│  📊 主题分布  │   😊 情感分布         │
│ [柱状图]      │   [饼图]             │
└──────────────┴──────────────────────┘
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
        [文字分析报告]
```

### 依赖库

新增依赖（已添加到 `requirements.txt`）：
```
matplotlib>=3.7.0
wordcloud>=1.9.0
pillow>=10.0.0
```

---

## 🎯 功能二：答案生成倾向控制

### 设计目标

为了验证分析引擎的准确性，需要能够生成具有明确倾向的测试数据：
- 生成积极倾向的答案 → 验证系统是否能识别出高满意度
- 生成消极倾向的答案 → 验证系统是否能识别出低满意度
- 对比分析结果与预期倾向 → 评估分析引擎的准确性

### 实现内容

#### 1. 倾向类型

支持5种回答倾向：

**1) 积极正面 (positive)**
- 量表题：倾向打4-5分
- 选择题：选择正面选项
- 开放题：表达满意、赞赏
- 适用场景：测试高满意度场景

**2) 消极负面 (negative)**
- 量表题：倾向打1-2分
- 选择题：选择负面选项
- 开放题：表达不满、批评
- 适用场景：测试低满意度场景

**3) 中立客观 (neutral)**
- 量表题：倾向打3分
- 选择题：选择中立选项
- 开放题：平衡表达优缺点
- 适用场景：测试客观评价场景

**4) 褒贬参半 (mixed)**
- 量表题：分数在2-4之间
- 选择题：正负选项混合
- 开放题：既肯定也批评
- 适用场景：测试复杂情感场景

**5) 随机分布 (random)**
- 自动按比例分配：
  - 40% 积极正面
  - 30% 中立客观
  - 20% 褒贬参半
  - 10% 消极负面
- 适用场景：模拟真实多样化的回答

#### 2. 使用流程

```bash
python generate_responses.py

# 1. 选择问卷
# 2. 输入生成数量
# 3. 选择回答倾向 ← 新增步骤
#    1. 积极正面
#    2. 消极负面  
#    3. 中立客观
#    4. 褒贬参半
#    5. 随机分布（默认）

# 4. 自动生成，实时显示倾向标签
[1/50] 生成答案... [😊 积极]
[2/50] 生成答案... [😊 积极]
...

# 5. 生成完毕，显示统计
📊 答案倾向分布统计：
😊 积极正面: 50 份 (100.0%)

🔍 预期分析结果：
  ✓ 分析报告应显示：高满意度、积极主题占主导、情感倾向偏正面

💡 使用建议：
  1. 在系统中对该问卷进行分析
  2. 对比分析结果与预期倾向
  3. 验证分析引擎的准确性
  4. 检查可视化图表是否符合数据分布
```

#### 3. 技术实现

**Prompt工程**：
- 根据选择的倾向，动态生成LLM指导语
- 在提示词中明确要求遵循指定倾向
- 确保量表题、选择题、开放题都符合倾向

**数据标注**：
- 每份答案自动添加 `response_tendency` 字段
- 保存倾向标签，便于后续分析和验证

**统计展示**：
- 实时统计各倾向的生成数量
- 计算百分比分布
- 提供预期分析结果的说明

### 验证流程

1. **生成积极倾向数据**
   ```bash
   python generate_responses.py
   # 选择倾向1：积极正面
   # 生成30份答案
   ```

2. **进行分析**
   - 在系统中对该问卷执行分析
   - 查看分析报告和可视化图表

3. **验证结果**
   - ✓ 词云图：是否出现积极词汇（如"满意"、"很好"、"推荐"）
   - ✓ 主题分布：积极主题是否占主导
   - ✓ 情感饼图：积极情感是否占大比例
   - ✓ 量表分布：分数是否集中在4-5分
   - ✓ 文字报告：总体摘要是否体现高满意度

4. **重复其他倾向**
   - 消极倾向 → 验证低满意度识别
   - 中立倾向 → 验证客观评价识别
   - 混合倾向 → 验证复杂情感识别

---

## 📁 相关文件

### 新增文件
- `app/services/visualization_service.py` - 可视化服务（438行）
- `VISUALIZATION_AND_TENDENCY_FEATURES.md` - 本文档

### 修改文件
- `generate_responses.py` - 增加倾向控制功能（140行新增）
- `app/services/analysis_engine.py` - 集成可视化生成（60行新增）
- `app/services/full_analysis_service.py` - 添加可视化服务（3行新增）
- `app/services/__init__.py` - 导出新服务
- `requirements.txt` - 新增可视化依赖
- `README.md` - 更新文档说明
- `run_all.py` - 前端显示可视化图表（50行新增）

---

## 🎨 用户体验提升

### 分析报告
**之前**：
- 纯文字报告
- 难以快速把握数据分布
- 需要人工脑补数据趋势

**现在**：
- 图文并茂的报告
- 一眼看出主题和情感分布
- 词云图直观展示高频词汇
- 专业、美观、易读

### 答案生成
**之前**：
- 生成随机答案
- 不确定数据倾向
- 难以验证分析准确性

**现在**：
- 可控制答案倾向
- 清楚知道数据特征
- 便于验证分析引擎
- 带倾向标签的实时反馈

---

## 🚀 后续扩展方向

### 可视化扩展
1. **更多图表类型**
   - 时间序列图（如果有时间维度）
   - 交叉分析热力图
   - 用户群体分群图

2. **交互式图表**
   - 使用 Plotly 等交互式可视化库
   - 支持图表缩放、筛选
   - 鼠标悬停显示详细信息

3. **导出功能**
   - 导出图表为高清PNG
   - 生成带图表的PDF报告
   - Excel数据导出

### 倾向控制扩展
1. **更细粒度控制**
   - 针对特定问题设置倾向
   - 针对不同题型设置不同倾向
   - 自定义倾向规则

2. **智能倾向生成**
   - 根据问卷主题自动推荐倾向
   - 基于真实数据学习倾向模式
   - A/B测试不同倾向组合

3. **倾向验证报告**
   - 自动生成验证报告
   - 对比预期 vs 实际分析结果
   - 计算分析准确率

---

## ✅ 质量保证

- ✅ 无 linter 错误
- ✅ 完整的代码注释
- ✅ 中文字体自动处理
- ✅ 异常情况容错（可视化库未安装时优雅降级）
- ✅ Base64编码图片，无需额外文件管理
- ✅ 倾向标签持久化保存
- ✅ 实时统计和反馈

---

## 📊 代码统计

- 新增Python代码：约 550 行
- 新增JavaScript代码：约 50 行
- 新增文档：约 400 行
- 修改现有代码：约 200 行
- 总计：约 1200 行

---

**实施人员**：AI Assistant  
**版本**：1.1.0  
**状态**：已完成，可立即使用

