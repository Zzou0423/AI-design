# AI 问卷生成与分析助手

智能问卷生成与分析工具，基于 RAG 和大语言模型。

## 📖 快速导航

- **🚀 新手入门**: 👉 查看 [`QUICKSTART.md`](QUICKSTART.md) - **5分钟快速上手指南** 
- **📚 完整文档**: 继续阅读本文档
- **🏗️ 项目结构**: [`docs/PROJECT_STRUCTURE.md`](docs/PROJECT_STRUCTURE.md)
- **🛠️ 脚本工具**: [`generate_responses.py`](generate_responses.py) - 批量答案生成器
- **💡 问题解决**: [`docs/`](docs/) 目录 - 各类技术文档

---

## ✨ 功能特性

- 🤖 **AI 智能生成**：根据需求自动生成专业问卷
- 📝 **多种题型**：单选题、多选题、量表题、开放式问题
- ✏️ **问卷编辑**：复制问卷创建新版本，支持完整编辑功能
- 👤 **用户系统**：注册登录，个人问卷管理
- 🔗 **分享链接**：一键生成和复制问卷链接
- 📊 **数据存储**：答案自动保存到本地
- 🤖 **批量生成答案**：使用AI自动生成问卷测试答案，支持多种身份模拟
- 🧠 **智能分析**：AI驱动的开放题分析，自动提取主题和洞察
- 🎨 **美观界面**：现代化设计

## 🚀 快速开始

### 1. 安装依赖

```bash
pip install -r requirements.txt
```

### 2. 配置环境

创建 `.env` 文件：

```
DASHSCOPE_API_KEY=your_api_key_here
```

### 3. 启动系统

```bash
python run_all.py
```

或使用启动脚本：

```bash
start.bat
```

浏览器将自动打开 http://localhost:8002

## 🎨 核心特性

### ✨ 智能需求扩写
- AI 作为行业专家帮助完善您的需求
- 将简要描述扩写为专业、详细的问卷需求

### 📊 可视化进度
- 实时显示生成步骤
- 进度条和状态动画
- 清晰反馈当前进度

### ✏️ 完整编辑功能
- 编辑问卷基本信息
- 添加/删除/修改问题
- 调整选项和量表范围
- 修改问题类型

### 🔗 一键分享
- 发布问卷生成分享链接
- 一键复制分享给他人
- 独立填写页面

## 📖 使用方法

### 生成问卷

1. 注册/登录账号
2. 在主页输入问卷需求（如："产品满意度调查"）
3. 点击"生成问卷"按钮
4. 等待 AI 生成问卷（约15-30秒）
5. 编辑问卷（可选）
6. 保存问卷

### 管理问卷

1. 进入"工作空间"查看所有问卷
2. 可以查看、分享、分析或删除问卷
3. 点击"分享"获取问卷链接
4. 将链接发送给他人填写

### 填写问卷

1. **单选题**：点击选项选择
2. **多选题**：可勾选多个选项
3. **量表题**：点击 1-5 的数字进行评价
4. **开放式问题**：在文本框中输入您的答案

### 查看答案

答案自动保存在 `data/responses/{问卷标题}_{问卷ID}/` 文件夹中，每个答案一个JSON文件。

### 批量生成问卷答案（AI辅助）

如果你需要批量生成问卷测试数据用于分析和测试，可以使用 `generate_responses.py` 脚本。

#### 功能说明

该脚本使用大语言模型（LLM）自动生成符合真实场景的问卷答案：
- 🎯 **通用适配**：自动列出所有问卷，支持任意主题
- 🎭 **智能身份生成**：根据问卷主题自动生成符合的受访者身份
- 📝 **高质量回答**：生成逻辑一致、真实自然的答案
- 🔄 **批量生成**：支持批量生成，自定义数量
- 💾 **自动保存**：答案自动保存到对应的问卷目录中

#### 使用方法

**交互式使用（推荐）**：

```bash
python generate_responses.py
```

脚本会自动：
1. 列出所有可用的问卷
2. 显示每个问卷的现有答案数
3. 让你选择要生成答案的问卷
4. 输入要生成的数量（默认30份）
5. 自动生成并保存答案

**使用示例**：

```
🤖 AI 问卷答案批量生成工具
================================================================================

可用的问卷：
----------------------------------------------------------------------
1. 国产动漫观众偏好与观感调查问卷
   ID: eac47ac0 | 现有答案: 100 份
2. 博美犬饲养习惯与偏好调查问卷
   ID: 83f37184 | 现有答案: 50 份
----------------------------------------------------------------------

请选择问卷编号 (输入 q 退出): 1

✓ 已选择: 国产动漫观众偏好与观感调查问卷

请输入要生成的答案数量 (默认 30，推荐 30-100): 50

选择回答倾向（用于验证分析结果的准确性）：
  1. 积极正面 (positive) - 高满意度、正面评价
  2. 消极负面 (negative) - 低满意度、负面评价  
  3. 中立客观 (neutral) - 中等评价、平衡反馈
  4. 褒贬参半 (mixed) - 混合评价、有好有坏
  5. 随机分布 (random) - 自动按比例分配不同倾向

请选择倾向 (1-5, 默认5): 1

✓ 已选择: 积极正面

[开始生成...]

📊 答案倾向分布统计：
😊 积极正面: 50 份 (100.0%)

🔍 预期分析结果：
  ✓ 分析报告应显示：高满意度、积极主题占主导、情感倾向偏正面

💡 使用建议：
  1. 在系统中对该问卷进行分析
  2. 对比分析结果与预期倾向
  3. 验证分析引擎的准确性
  4. 检查可视化图表是否符合数据分布
```

#### 特点

- **智能身份生成**：脚本会调用LLM根据问卷主题生成15个不同类型的受访者身份
- **倾向控制** ✨：可以指定答案的整体倾向（积极/消极/中立/参半/随机）
  - 用于验证分析结果的准确性
  - 生成带标签的测试数据
  - 自动显示倾向分布统计和预期分析结果
- **并发生成** 🚀：支持多线程并发生成，大幅提升速度
  - 默认5个并发，可调整3-10
  - 30份答案约1-2分钟完成（原来需要3-5分钟）
  - 100份答案约3-6分钟完成（原来需要10-15分钟）
- **实时进度显示**：显示批次进度、已用时间、预计剩余时间
- **错误容错**：单个答案生成失败不会中断整个流程

#### 注意事项

1. **API调用费用**：生成答案需要调用大语言模型API，会产生费用
   - 30份答案约消耗：0.5-1元（取决于问卷复杂度）
   - 100份答案约消耗：2-4元
2. **生成时间**（并发模式，默认5并发）：
   - 30份答案：约1-2分钟
   - 100份答案：约3-6分钟
   - 可通过增加并发数进一步提速
3. **数据用途**：生成的答案用于测试和演示，不建议作为真实调查数据

### 📊 问卷分析功能

系统提供两种基于AI的智能分析模式，满足不同深度的分析需求。

#### 🔍 两种分析模式

##### 1. 📝 开放题分析（Open-ended Analysis）

**适用场景**：快速了解用户的文本反馈和意见

**分析内容**：
- 专注于开放式问题的定性分析
- 自动识别核心主题和关键议题
- 情感倾向标注（积极/消极/中性）
- 提取代表性用户引述
- 生成基础行动建议

**分析速度**：30-60秒

##### 2. 🎯 全量分析（Full Analysis）

**适用场景**：需要全面了解问卷结果并获得战略洞察

**分析内容**：
- **综合所有题型**：选择题、量表题、开放题
- **深度交叉洞察**：发现不同问题之间的关联模式
- **关键少数派分析**：识别高价值群体和强烈不满群体
- **因果推断**：用量化数据解释定性现象
- **风险与机会识别**：标注关键风险点和机会点
- **战略建议**：提供优先级排序的可落地行动指南

**分析速度**：1-2分钟

#### 分析流程

1. 在工作空间点击问卷的"分析"按钮
2. **选择分析类型**：开放题分析 或 全量分析
3. 点击"开始分析"
4. 等待AI完成分析
5. 查看结构化的分析报告

#### 全量分析报告示例

```markdown
# 全量分析诊断报告

## 一、核心摘要
本次调研显示用户对产品功能整体满意度较高（平均4.2分），
但在价格敏感度和客服响应方面存在显著改进空间。

## 二、关键发现

### 发现1：价格敏感用户群体满意度显著偏低（重要性：高）
- **数据支撑**：打分≤3分的用户中，83%在开放题中提及"价格过高"
- **分析解读**：价格成为低满意度的核心驱动因素

### 发现2：重度用户高度认可产品核心功能（重要性：高）
- **数据支撑**：每周使用≥5次的用户满意度平均4.8分
- **分析解读**：产品核心价值获得验证

## 三、深度交叉洞察

### 3.1 关联模式
在"功能满意度"打高分(4-5分)的用户中，92%选择了"会推荐给朋友"，
显示功能体验与推荐意愿高度正相关。

### 3.2 因果推断
量表题显示"客服响应速度"平均仅3.1分，对应的开放题中
"等待时间过长"被提及23次，验证了量化数据的合理性。

## 四、风险与机会

### 🚨 主要风险
1. **价格竞争力不足**：可能导致潜在用户流失
2. **客服体验拖累整体满意度**：虽非核心功能但影响大

### ✨ 核心机会
1. **强化重度用户生态**：高忠诚度用户可发展为品牌大使
2. **功能优势放大**：在市场传播中强调核心功能优势

## 五、战略建议与行动指南

### 优先级1：优化定价策略
- **行动内容**：考虑推出基础版/标准版/高级版分层定价
- **数据依据**：83%的低满意度用户提及价格问题
- **预期效果**：提升价格敏感用户的接受度，扩大市场覆盖

### 优先级2：建立快速响应客服体系
- **行动内容**：引入智能客服+人工协同，承诺15分钟响应
- **数据依据**：客服响应速度仅3.1分，远低于其他维度
- **预期效果**：提升整体满意度0.5-1分
```

#### 开放题分析报告示例

```
📊 总体摘要
用户对产品整体满意，特别赞赏界面设计和易用性，
但在性能和客服响应速度方面存在改进空间。

🎯 核心主题

✅ 积极反馈
- 界面设计美观 (提及12次)
  "界面设计很现代化，用起来很舒服"
  
⚠️ 需要关注
- 加载速度慢 (提及8次)
  "有时候加载很慢，需要等很久"

💡 行动建议
1. 保持并强化界面设计优势
2. 优化系统性能，提升加载速度
3. 加强客服培训，提高响应效率
```

#### 使用建议

- **开放题分析**：
  - 确保问卷包含开放式问题
  - 建议至少10-20份回答
  - 适合快速了解用户意见

- **全量分析**：
  - 建议问卷包含多种题型（选择题+量表题+开放题）
  - 建议至少30-50份回答以获得有效的交叉洞察
  - 适合制定战略决策和深度诊断
  - 回答质量越高，分析结果越准确

## 📁 项目结构

```
ai_survey_assistant/
├── app/                    # 应用核心
│   ├── chains/             # LLM 链
│   │   └── survey_creation_chain.py      # 问卷生成链
│   ├── services/           # 业务服务
│   │   ├── survey_service.py            # 问卷服务
│   │   ├── analysis_engine.py           # 分析引擎（开放题）
│   │   ├── qualitative_analyzer.py      # 定性分析器
│   │   └── full_analysis_service.py     # 全量分析服务 ✨
│   ├── core/               # 核心功能
│   │   └── vector_store.py              # 向量存储
│   ├── models/             # 数据模型
│   │   ├── user.py                      # 用户模型
│   │   └── analysis_models.py           # 分析模型（含全量分析）
│   └── utils/              # 工具类
│       ├── response_saver.py            # 答案保存
│       ├── session_manager.py           # 会话管理
│       └── user_survey_manager.py       # 用户问卷管理
├── static/                 # 前端文件
│   ├── app.js              # 主页逻辑
│   ├── fill_survey.js      # 填写页逻辑
│   ├── login.html          # 登录页面
│   ├── workspace.html      # 工作空间
│   └── style.css           # 样式
├── data/                   # 数据文件
│   ├── surveys/            # 问卷存储
│   ├── responses/          # 答案存储
│   ├── analyses/           # 分析结果存储
│   ├── chroma_db/          # 向量数据库
│   ├── users.json          # 用户数据
│   ├── sessions.json       # 会话数据
│   └── user_surveys.json   # 用户问卷映射
├── run_all.py              # 主入口
├── generate_responses.py   # 批量生成答案脚本
├── start.bat               # Windows启动脚本
└── requirements.txt        # 依赖列表
```

## 🔧 API 接口

### 用户相关
- `POST /api/register` - 用户注册
- `POST /api/login` - 用户登录
- `POST /api/logout` - 用户登出
- `GET /api/user/info` - 获取用户信息
- `GET /api/user/surveys` - 获取用户问卷列表
- `DELETE /api/user/surveys/{survey_id}` - 删除问卷

### 问卷相关
- `POST /api/generate` - 生成问卷（流式响应）
- `POST /api/save-survey` - 保存问卷
- `GET /api/survey/{survey_id}` - 获取问卷
- `GET /api/survey/{survey_id}/stats` - 获取统计数据

### 答案相关
- `POST /api/submit-response` - 提交问卷答案
- `GET /fill/{survey_id}` - 独立填写页面

### 分析相关
- `POST /api/analyze/{survey_id}` - 分析问卷结果
  - 请求体: `{"analysis_type": "open_ended"}` 或 `{"analysis_type": "full"}`
  - `open_ended`: 仅分析开放题（默认）
  - `full`: 全量分析所有题型
- `GET /survey/{survey_id}?action=analyze` - 分析页面

## 🛠️ 技术栈

### 后端
- **FastAPI** - 现代化Web框架
- **LangChain** - AI应用开发框架
- **ChromaDB** - 向量数据库
- **DashScope** - 阿里云通义千问大语言模型
  - **主要LLM模型**：
    - `qwen-plus`：默认使用，平衡性能与成本
    - `qwen-max`：高级任务使用（如问卷生成），能力最强
    - `qwen-turbo`：可选，速度最快，成本最低
  - **嵌入模型**：
    - `text-embedding-v3`：用于向量存储和语义搜索
- **Pydantic** - 数据验证和模型

### 前端
- **原生JavaScript** - 前端交互逻辑
- **HTML/CSS** - 用户界面
- **Server-Sent Events** - 实时流式响应

### 数据处理
- **Pandas** - 数据处理
- **NumPy** - 数值计算
- **Jieba** - 中文分词

## 📝 数据格式

### 问卷格式

```json
{
  "id": "survey_id",
  "title": "问卷标题",
  "description": "问卷描述",
  "created_at": "2025-10-30T10:00:00",
  "estimated_time": 5,
  "questions": [
    {
      "id": 1,
      "type": "单选题",
      "text": "问题文本",
      "required": true,
      "options": ["选项1", "选项2", "选项3"]
    },
    {
      "id": 2,
      "type": "量表题",
      "text": "满意度评价",
      "required": true,
      "scale_min": 1,
      "scale_max": 5,
      "scale_min_label": "非常不满意",
      "scale_max_label": "非常满意"
    },
    {
      "id": 3,
      "type": "开放式问题",
      "text": "您还有什么建议？",
      "required": false
    }
  ]
}
```

### 答案格式

```json
{
  "survey_id": "survey_id",
  "survey_info": {
    "title": "问卷标题",
    "description": "问卷描述"
  },
  "submitted_at": "2025-10-30T12:00:00",
  "answers": {
    "1": "选项A",
    "2": 4,
    "3": "这是一个很好的产品，我很满意"
  }
}
```

### 分析结果格式

```json
{
  "survey_id": "survey_id",
  "survey_title": "问卷标题",
  "total_responses": 50,
  "open_ended_responses_count": 45,
  "analysis_type": "定性分析",
  "status": "success",
  "report": {
    "summary": "总体摘要",
    "themes": [
      {
        "theme": "界面设计",
        "sentiment": "positive",
        "quote": "界面设计很现代化",
        "count": 12,
        "description": "用户对界面设计评价积极"
      }
    ],
    "recommendation": "行动建议"
  }
}
```

## 💡 故障排查

### 常见问题

1. **API Key 未配置**
   - 检查 `.env` 文件是否存在
   - 确认 `DASHSCOPE_API_KEY` 已设置
   - 获取API Key: https://dashscope.console.aliyun.com/

2. **依赖安装失败**
   - 使用虚拟环境：`python -m venv venv`
   - 激活虚拟环境：
     - Windows: `venv\Scripts\activate`
   - 升级pip: `python -m pip install --upgrade pip`
   - 重新安装：`pip install -r requirements.txt`

3. **端口被占用**
   - 默认端口8002被占用时，系统会自动尝试8003-8009
   - 或在 `run_all.py` 中修改端口号

4. **向量数据库未初始化**
   - 系统会自动加载向量数据库
   - 如果加载失败，RAG功能将不可用，但不影响基本功能
   - 可以忽略警告继续使用

5. **分析功能报错**
   - 确保问卷包含开放式问题
   - 确保至少有1份问卷回答
   - 检查API Key是否有效

## 🔐 安全说明

- 用户密码使用SHA-256哈希存储
- 会话令牌自动过期清理
- 用户只能访问自己的问卷
- 所有数据本地存储

## 🎯 最佳实践

1. **问卷设计**
   - 问题简洁明了
   - 包含多种题型以获得丰富数据
   - 至少包含1-2个开放式问题用于分析

2. **数据收集**
   - 先生成少量测试数据验证问卷
   - 使用分享链接广泛收集真实数据
   - 定期查看回答数量

3. **结果分析**
   - 等待收集足够样本（建议10+）再进行分析
   - 结合定量和定性数据综合判断
   - 关注高频主题和情感倾向

## 📄 许可证

MIT License

## 🤝 贡献

欢迎提交体验反馈

## 📧 联系方式

如有问题或建议，欢迎通过vx联系（15156018835）。
